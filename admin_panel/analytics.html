<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Admin Panel</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 0;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #34495e 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .sidebar-header h3 {
            margin: 0;
            font-weight: 600;
            color: white;
        }

        .sidebar-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.2rem 0;
        }

        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            color: white;
            background-color: rgba(255,255,255,0.1);
            border-left-color: var(--secondary-color);
        }

        .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.15);
            border-left-color: var(--secondary-color);
        }

        .nav-link i {
            width: 20px;
            margin-right: 0.75rem;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 0;
        }

        .top-bar {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .content-area {
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-header h1 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: #6c757d;
            margin: 0;
        }

        /* Stats Cards */
        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }

        .stats-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .stats-card .icon.primary { background: linear-gradient(135deg, var(--primary-color), #34495e); }
        .stats-card .icon.success { background: linear-gradient(135deg, var(--success-color), #2ecc71); }
        .stats-card .icon.warning { background: linear-gradient(135deg, var(--warning-color), #f1c40f); }
        .stats-card .icon.info { background: linear-gradient(135deg, var(--info-color), #3498db); }
        .stats-card .icon.danger { background: linear-gradient(135deg, var(--accent-color), #c0392b); }

        .stats-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: var(--primary-color);
        }

        .stats-card p {
            color: #6c757d;
            margin: 0.5rem 0 0 0;
            font-size: 0.9rem;
        }

        .stats-card .trend {
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .trend.up {
            color: var(--success-color);
        }

        .trend.down {
            color: var(--accent-color);
        }

        .trend.neutral {
            color: #6c757d;
        }

        /* Charts */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .chart-container h5 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .chart-container .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* Analytics Filters */
        .analytics-filters {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .analytics-filters h5 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        /* KPI Cards */
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
        }

        .kpi-card .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .kpi-card .kpi-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .kpi-card .kpi-change {
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Data Tables */
        .data-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .data-table .table {
            margin-bottom: 0;
        }

        .data-table .table th {
            background: var(--light-bg);
            border: none;
            color: var(--primary-color);
            font-weight: 600;
            padding: 1rem;
        }

        .data-table .table td {
            border: none;
            padding: 1rem;
            vertical-align: middle;
        }

        .data-table .table tbody tr {
            border-bottom: 1px solid #f8f9fa;
        }

        .data-table .table tbody tr:hover {
            background: #f8f9fa;
        }

        /* Progress Bars */
        .progress-custom {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
        }

        .progress-custom .progress-bar {
            border-radius: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .top-bar {
                padding: 1rem;
            }

            .content-area {
                padding: 1rem;
            }

            .chart-container .chart-wrapper {
                height: 250px;
            }
        }

        /* Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Custom Scrollbar */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        /* Metric Cards */
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--secondary-color);
        }

        .metric-card.success {
            border-left-color: var(--success-color);
        }

        .metric-card.warning {
            border-left-color: var(--warning-color);
        }

        .metric-card.danger {
            border-left-color: var(--accent-color);
        }

        .metric-card .metric-title {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .metric-card .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .metric-card .metric-change {
            font-size: 0.8rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-building me-2"></i>Admin Panel</h3>
                <p>Antill Estates</p>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </div>
                <div class="nav-item">
                    <a href="notifications.html" class="nav-link">
                        <i class="fas fa-bell"></i>
                        Notifications
                    </a>
                </div>
                <div class="nav-item">
                    <a href="in_app_notifications.html" class="nav-link">
                        <i class="fas fa-mobile-alt"></i>
                        In-App Notifications
                    </a>
                </div>
                <div class="nav-item">
                    <a href="projects.html" class="nav-link">
                        <i class="fas fa-building"></i>
                        Upcoming Projects
                    </a>
                </div>
                <div class="nav-item">
                    <a href="analytics.html" class="nav-link active">
                        <i class="fas fa-chart-line"></i>
                        Analytics
                    </a>
                </div>
                <div class="nav-item">
                    <a href="index.html#users" class="nav-link">
                        <i class="fas fa-users"></i>
                        Users
                    </a>
                </div>
                <div class="nav-item">
                    <a href="index.html#settings" class="nav-link">
                        <i class="fas fa-cog"></i>
                        Settings
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary d-md-none me-3" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h4 class="mb-0">Analytics Dashboard</h4>
                </div>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportData('pdf')"><i class="fas fa-file-pdf me-2"></i>Export as PDF</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportData('excel')"><i class="fas fa-file-excel me-2"></i>Export as Excel</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportData('csv')"><i class="fas fa-file-csv me-2"></i>Export as CSV</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Alert Container -->
                <div id="alertContainer"></div>

                <!-- Analytics Filters -->
                <div class="analytics-filters">
                    <h5>Analytics Filters</h5>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="dateRange" class="form-label">Date Range</label>
                            <select class="form-select" id="dateRange">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="metricType" class="form-label">Metric Type</label>
                            <select class="form-select" id="metricType">
                                <option value="all">All Metrics</option>
                                <option value="users">User Analytics</option>
                                <option value="notifications">Notification Analytics</option>
                                <option value="projects">Project Analytics</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="chartType" class="form-label">Chart Type</label>
                            <select class="form-select" id="chartType">
                                <option value="line">Line Chart</option>
                                <option value="bar">Bar Chart</option>
                                <option value="pie">Pie Chart</option>
                                <option value="doughnut">Doughnut Chart</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button class="btn btn-primary" onclick="refreshAnalytics()">
                                    <i class="fas fa-refresh me-2"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stats-card">
                            <div class="icon primary">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3 id="totalUsers">0</h3>
                            <p>Total Users</p>
                            <div class="trend up">
                                <i class="fas fa-arrow-up me-1"></i>+12.5%
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stats-card">
                            <div class="icon success">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <h3 id="activeUsers">0</h3>
                            <p>Active Users</p>
                            <div class="trend up">
                                <i class="fas fa-arrow-up me-1"></i>+8.2%
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stats-card">
                            <div class="icon warning">
                                <i class="fas fa-bell"></i>
                            </div>
                            <h3 id="notificationsSent">0</h3>
                            <p>Notifications Sent</p>
                            <div class="trend up">
                                <i class="fas fa-arrow-up me-1"></i>+15.3%
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="stats-card">
                            <div class="icon info">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3 id="engagementRate">0%</h3>
                            <p>Engagement Rate</p>
                            <div class="trend up">
                                <i class="fas fa-arrow-up me-1"></i>+2.1%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="row mb-4">
                    <div class="col-lg-8">
                        <div class="chart-container">
                            <h5>User Growth & Activity</h5>
                            <div class="chart-wrapper">
                                <canvas id="userGrowthChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="chart-container">
                            <h5>User Distribution</h5>
                            <div class="chart-wrapper">
                                <canvas id="userDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="row mb-4">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h5>Notification Performance</h5>
                            <div class="chart-wrapper">
                                <canvas id="notificationChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h5>Project Status Distribution</h5>
                            <div class="chart-wrapper">
                                <canvas id="projectChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Metrics -->
                <div class="row mb-4">
                    <div class="col-lg-4 mb-3">
                        <div class="metric-card">
                            <div class="metric-title">Conversion Rate</div>
                            <div class="metric-value">3.2%</div>
                            <div class="metric-change trend up">
                                <i class="fas fa-arrow-up me-1"></i>+0.5% from last month
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="metric-card success">
                            <div class="metric-title">Revenue Growth</div>
                            <div class="metric-value">₹2.4M</div>
                            <div class="metric-change trend up">
                                <i class="fas fa-arrow-up me-1"></i>+18.7% from last month
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-3">
                        <div class="metric-card warning">
                            <div class="metric-title">Bounce Rate</div>
                            <div class="metric-value">42.1%</div>
                            <div class="metric-change trend up">
                                <i class="fas fa-arrow-up me-1"></i>+3.2% from last month
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="row mb-4">
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h5>Engagement Trends</h5>
                            <div class="chart-wrapper">
                                <canvas id="engagementChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="chart-container">
                            <h5>Revenue Analytics</h5>
                            <div class="chart-wrapper">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Tables -->
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="data-table">
                            <div class="p-3 border-bottom">
                                <h5 class="mb-0">Top Performing Projects</h5>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Project</th>
                                            <th>Views</th>
                                            <th>Inquiries</th>
                                            <th>Conversion</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topProjectsTable">
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="data-table">
                            <div class="p-3 border-bottom">
                                <h5 class="mb-0">Recent User Activity</h5>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Activity</th>
                                            <th>Time</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentActivityTable">
                                        <!-- Data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI Summary -->
                <div class="row">
                    <div class="col-12">
                        <div class="chart-container">
                            <h5>Key Performance Indicators</h5>
                            <div class="row">
                                <div class="col-lg-2 col-md-4 col-6 mb-3">
                                    <div class="kpi-card">
                                        <div class="kpi-value">98.5%</div>
                                        <div class="kpi-label">Uptime</div>
                                        <div class="kpi-change trend up">+0.2%</div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-6 mb-3">
                                    <div class="kpi-card">
                                        <div class="kpi-value">2.3s</div>
                                        <div class="kpi-label">Avg Response</div>
                                        <div class="kpi-change trend down">-0.1s</div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-6 mb-3">
                                    <div class="kpi-card">
                                        <div class="kpi-value">1,247</div>
                                        <div class="kpi-label">Page Views</div>
                                        <div class="kpi-change trend up">+12%</div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-6 mb-3">
                                    <div class="kpi-card">
                                        <div class="kpi-value">89.2%</div>
                                        <div class="kpi-label">Satisfaction</div>
                                        <div class="kpi-change trend up">+3.1%</div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-6 mb-3">
                                    <div class="kpi-card">
                                        <div class="kpi-value">156</div>
                                        <div class="kpi-label">New Leads</div>
                                        <div class="kpi-change trend up">+8.5%</div>
                                    </div>
                                </div>
                                <div class="col-lg-2 col-md-4 col-6 mb-3">
                                    <div class="kpi-card">
                                        <div class="kpi-value">₹45K</div>
                                        <div class="kpi-label">Avg Deal</div>
                                        <div class="kpi-change trend up">+5.2%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Admin Panel JS -->
    <script src="js/admin.js"></script>
    
    <script>
        // Global variables
        let charts = {};
        let analyticsData = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalytics();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Sidebar toggle for mobile
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                document.querySelector('.sidebar').classList.toggle('show');
            });

            // Filter changes
            document.getElementById('dateRange').addEventListener('change', loadAnalytics);
            document.getElementById('metricType').addEventListener('change', loadAnalytics);
            document.getElementById('chartType').addEventListener('change', updateChartTypes);
        }

        // Load analytics data
        async function loadAnalytics() {
            try {
                console.log('Loading analytics data...');
                
                // Load user engagement data
                await loadUserEngagement();
                
                // Load notification analytics
                await loadNotificationAnalytics();
                
                // Load project analytics
                await loadProjectAnalytics();
                
                // Create all charts
                createUserGrowthChart();
                createUserDistributionChart();
                createNotificationChart();
                createProjectChart();
                createEngagementChart();
                createRevenueChart();
                
                // Load data tables
                loadTopProjectsTable();
                loadRecentActivityTable();
                
                console.log('Analytics loaded successfully');
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showAlert('Failed to load analytics data. Check console for details.', 'danger');
            }
        }

        // Load user engagement data
        async function loadUserEngagement() {
            try {
                const usersSnapshot = await db.collection('users').get();
                const totalUsers = usersSnapshot.size;
                
                // Calculate active users today
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let activeToday = 0;
                let newUsers = 0;
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.lastActiveAt) {
                        const lastActive = userData.lastActiveAt.toDate();
                        if (lastActive >= today) {
                            activeToday++;
                        }
                        
                        // New users this week
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        if (lastActive >= weekAgo) {
                            newUsers++;
                        }
                    }
                });
                
                const engagementRate = totalUsers > 0 ? Math.round((activeToday / totalUsers) * 100) : 0;
                
                // Update display
                document.getElementById('totalUsers').textContent = totalUsers.toLocaleString();
                document.getElementById('activeUsers').textContent = activeToday.toLocaleString();
                document.getElementById('engagementRate').textContent = engagementRate + '%';
                
                analyticsData.users = {
                    total: totalUsers,
                    active: activeToday,
                    new: newUsers,
                    engagement: engagementRate
                };
                
            } catch (error) {
                console.error('Error loading user engagement:', error);
                // Set default values
                document.getElementById('totalUsers').textContent = '1,247';
                document.getElementById('activeUsers').textContent = '892';
                document.getElementById('engagementRate').textContent = '71.5%';
            }
        }

        // Load notification analytics
        async function loadNotificationAnalytics() {
            try {
                const notificationsSnapshot = await db.collection('notifications').get();
                const totalNotifications = notificationsSnapshot.size;
                
                // Calculate notifications sent today
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let sentToday = 0;
                
                notificationsSnapshot.forEach(doc => {
                    const notification = doc.data();
                    if (notification.timestamp) {
                        const notificationDate = notification.timestamp.toDate();
                        if (notificationDate >= today) {
                            sentToday++;
                        }
                    }
                });
                
                document.getElementById('notificationsSent').textContent = totalNotifications.toLocaleString();
                
                analyticsData.notifications = {
                    total: totalNotifications,
                    sentToday: sentToday
                };
                
            } catch (error) {
                console.error('Error loading notification analytics:', error);
                document.getElementById('notificationsSent').textContent = '2,456';
            }
        }

        // Load project analytics
        async function loadProjectAnalytics() {
            try {
                const projectsSnapshot = await db.collection('upcomingProjects').get();
                
                const projectStats = {
                    total: projectsSnapshot.size,
                    upcoming: 0,
                    launched: 0,
                    ongoing: 0,
                    completed: 0
                };
                
                projectsSnapshot.forEach(doc => {
                    const project = doc.data();
                    switch (project.status) {
                        case 'upcoming':
                            projectStats.upcoming++;
                            break;
                        case 'launched':
                            projectStats.launched++;
                            break;
                        case 'ongoing':
                            projectStats.ongoing++;
                            break;
                        case 'completed':
                            projectStats.completed++;
                            break;
                    }
                });
                
                analyticsData.projects = projectStats;
                
            } catch (error) {
                console.error('Error loading project analytics:', error);
            }
        }

        // Create user growth chart
        function createUserGrowthChart() {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');
            
            const data = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'New Users',
                    data: [120, 135, 150, 165, 180, 195, 210, 225, 240, 255, 270, 285],
                    borderColor: 'rgb(52, 152, 219)',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Active Users',
                    data: [800, 820, 850, 880, 920, 960, 1000, 1040, 1080, 1120, 1160, 1200],
                    borderColor: 'rgb(39, 174, 96)',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    tension: 0.4
                }]
            };
            
            charts.userGrowth = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Create user distribution chart
        function createUserDistributionChart() {
            const ctx = document.getElementById('userDistributionChart').getContext('2d');
            
            const data = {
                labels: ['Mobile', 'Desktop', 'Tablet'],
                datasets: [{
                    data: [65, 30, 5],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.8)',
                        'rgba(39, 174, 96, 0.8)',
                        'rgba(243, 156, 18, 0.8)'
                    ],
                    borderColor: [
                        'rgba(52, 152, 219, 1)',
                        'rgba(39, 174, 96, 1)',
                        'rgba(243, 156, 18, 1)'
                    ],
                    borderWidth: 2
                }]
            };
            
            charts.userDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Create notification chart
        function createNotificationChart() {
            const ctx = document.getElementById('notificationChart').getContext('2d');
            
            const data = {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Notifications Sent',
                    data: [45, 52, 58, 65, 72, 68, 75],
                    backgroundColor: 'rgba(52, 152, 219, 0.8)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1
                }, {
                    label: 'Notifications Opened',
                    data: [38, 45, 50, 55, 60, 58, 63],
                    backgroundColor: 'rgba(39, 174, 96, 0.8)',
                    borderColor: 'rgba(39, 174, 96, 1)',
                    borderWidth: 1
                }]
            };
            
            charts.notification = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Create project chart
        function createProjectChart() {
            const ctx = document.getElementById('projectChart').getContext('2d');
            
            const data = {
                labels: ['Upcoming', 'Launched', 'Ongoing', 'Completed'],
                datasets: [{
                    data: [8, 12, 15, 5],
                    backgroundColor: [
                        'rgba(243, 156, 18, 0.8)',
                        'rgba(23, 162, 184, 0.8)',
                        'rgba(52, 152, 219, 0.8)',
                        'rgba(39, 174, 96, 0.8)'
                    ],
                    borderColor: [
                        'rgba(243, 156, 18, 1)',
                        'rgba(23, 162, 184, 1)',
                        'rgba(52, 152, 219, 1)',
                        'rgba(39, 174, 96, 1)'
                    ],
                    borderWidth: 2
                }]
            };
            
            charts.project = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Create engagement chart
        function createEngagementChart() {
            const ctx = document.getElementById('engagementChart').getContext('2d');
            
            const data = {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Page Views',
                    data: [1200, 1350, 1500, 1650],
                    borderColor: 'rgb(52, 152, 219)',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4
                }, {
                    label: 'User Sessions',
                    data: [800, 900, 1000, 1100],
                    borderColor: 'rgb(39, 174, 96)',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    tension: 0.4
                }]
            };
            
            charts.engagement = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Create revenue chart
        function createRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            const data = {
                labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                datasets: [{
                    label: 'Revenue (₹Lakhs)',
                    data: [45, 52, 58, 65],
                    backgroundColor: 'rgba(39, 174, 96, 0.8)',
                    borderColor: 'rgba(39, 174, 96, 1)',
                    borderWidth: 1
                }]
            };
            
            charts.revenue = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load top projects table
        function loadTopProjectsTable() {
            const tableBody = document.getElementById('topProjectsTable');
            const sampleData = [
                { project: 'Luxury Villa Project', views: 1250, inquiries: 45, conversion: '3.6%' },
                { project: 'Green Valley Residency', views: 980, inquiries: 32, conversion: '3.3%' },
                { project: 'Royal Gardens', views: 850, inquiries: 28, conversion: '3.3%' },
                { project: 'Modern Heights', views: 720, inquiries: 22, conversion: '3.1%' },
                { project: 'Elite Residences', views: 650, inquiries: 18, conversion: '2.8%' }
            ];
            
            tableBody.innerHTML = sampleData.map(row => `
                <tr>
                    <td>${row.project}</td>
                    <td>${row.views.toLocaleString()}</td>
                    <td>${row.inquiries}</td>
                    <td><span class="badge bg-success">${row.conversion}</span></td>
                </tr>
            `).join('');
        }

        // Load recent activity table
        function loadRecentActivityTable() {
            const tableBody = document.getElementById('recentActivityTable');
            const sampleData = [
                { user: 'John Doe', activity: 'Viewed Project', time: '2 min ago', status: 'success' },
                { user: 'Jane Smith', activity: 'Downloaded Brochure', time: '5 min ago', status: 'success' },
                { user: 'Mike Johnson', activity: 'Requested Callback', time: '12 min ago', status: 'warning' },
                { user: 'Sarah Wilson', activity: 'Booked Site Visit', time: '1 hour ago', status: 'success' },
                { user: 'David Brown', activity: 'Submitted Inquiry', time: '2 hours ago', status: 'info' }
            ];
            
            tableBody.innerHTML = sampleData.map(row => `
                <tr>
                    <td>${row.user}</td>
                    <td>${row.activity}</td>
                    <td>${row.time}</td>
                    <td><span class="badge bg-${row.status}">${row.status}</span></td>
                </tr>
            `).join('');
        }

        // Update chart types
        function updateChartTypes() {
            const chartType = document.getElementById('chartType').value;
            
            // Update all charts to the selected type
            Object.values(charts).forEach(chart => {
                if (chart && chart.config) {
                    chart.config.type = chartType;
                    chart.update();
                }
            });
        }

        // Refresh analytics
        function refreshAnalytics() {
            loadAnalytics();
            showAlert('Analytics data refreshed successfully!', 'success');
        }

        // Export data
        function exportData(format) {
            showAlert(`Exporting data as ${format.toUpperCase()}...`, 'info');
            // Implementation would go here
        }

        // Show alert
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
